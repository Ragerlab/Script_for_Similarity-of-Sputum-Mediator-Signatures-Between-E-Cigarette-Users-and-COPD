---
title: "COPD Summary Tables and Variable by Variable Analysis"
author: "Elise Hickman"
date: "Most recent revision date: 7/17/2025"
output: 
  html_document:
    code_folding: show
    toc: true
    toc_depth: 6
    number_sections: true
---

# Load packages

```{r message = FALSE, warning = FALSE}
# Clears global environment
rm(list = ls(all.names = TRUE)) 

# If needed, install and load packages
library(this.path) # For file path
library(openxlsx) # for data import
library(janitor) # for data organization
library(tidyverse) # for data cleaning and organization
library(table1) # to make tables
library(rstatix) # for stats testing
library(rstatix) # for Dunn's test
library(FSA) # package that contains Dunn test function
library(emmeans) # for emmeans posthoc test
library(DT) # for display of data tables
library(ggfortify) # for PCA
library(factoextra) # for PCA 
library(pheatmap) # for making heatmap
library(viridis) # for heatmap color scheme
library(patchwork) # for figure panel

# Redefine masked functions
select <- dplyr::select
rename <- dplyr::rename
margin <- ggplot2::margin

# Set theme
theme_set(theme_bw())

# Set working directory
setwd(this.dir())
```

# Data Import and Organization

## Soluble Mediator Data

Data import.
```{r}
# Import single-plex (sp) mediator data (md)
md_sp <- data.frame(read.xlsx("1_RawData/2022_04_19 COPD Mediator Data Single ELISAs.xlsx"))

# Import mesoscale (msd) mediator data (md)
md_msd <- data.frame(read.xlsx("1_RawData/2022_04_19 COPD Mediator Data MSD.xlsx"))

# Combine data from single-plex and MSD matricies, and remove unnecessary sample ID columns
md_raw <- md_sp %>%
  left_join(md_msd, by = "ExpSampleID") %>%
  select(-c(LAB_ID, ExpSampleID))
```

We realized after completing assays that some of the subjects were measured in duplicate. The below code averages the duplicates (manual calling of the specific subjects that were duplicates).
```{r}
# Subjects with duplicate entries
subj_dups <- c("MU160833", "SF181538", "UT171009")

# Extract rows from samples that have duplicate measurements
md_duplicates_avg <- md_raw %>%
  filter(SubjectID %in% subj_dups) %>% 
  group_by(SubjectID) %>% 
  summarize(across(everything(), mean))

# Remove rows from original data frame that contain data from the duplicate subjects, then add back in averaged data for duplicate samples
md <- md_raw %>%
  filter(!SubjectID %in% subj_dups) %>%
  bind_rows(md_duplicates_avg) %>%
  column_to_rownames("SubjectID")

# Change 0s to NAs because that is a more accurate reflection of their values
md <- md %>%
  mutate(across(where(is.numeric), ~ na_if(., 0))) %>%
  select(sort(names(.)))

# Write out cleaned up data
write.xlsx(md %>% rownames_to_column("SubjectID"), "2_ProcessedData/COPD_MediatorData_Raw_Cleaned_07.17.2025.xlsx")
```

Ensure dataframe contains only mediators with less than 75% missing data (81 participants out of 109). This removed zero mediators. 
```{r}
md <- md %>%
  select(where(~ sum(is.na(.)) <= 81))
```

Prepare dataframe for imputation using GSimp. The final dataframe for imputation should have the samples in rows, proteins in columns, and one of the samples is labeled "mdl", reflecting the minimum detected concentration.
```{r}
# Prepare vector of lowest detected concentrations
llods <- md %>%
  rownames_to_column("SubjectID") %>%
  pivot_longer(!SubjectID, names_to = "variable", values_to = "value") %>%
  group_by(variable) %>%
  summarise(mdl = min(value, na.rm = TRUE))

# Append lowest detected concentrations and format dataframe
md_forimp <- md %>%
  t() %>% data.frame() %>%
  rownames_to_column("variable") %>%
  left_join(llods, by = "variable") %>%
  column_to_rownames("variable") %>%
  t() %>% data.frame()
```

Read in GSimp functions:
```{r message = FALSE, warning = FALSE}
# Load GSimp functions
options(stringsAsFactors = F)

source('~/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/Rager_Lab/Projects_Lead/3_COPDEcig_Comparison/2_Current_Analyses/1_SummaryTables_VariablebyVariable/3_GSimp/Trunc_KNN/Imput_funcs.r', local = TRUE)

source('~/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/Rager_Lab/Projects_Lead/3_COPDEcig_Comparison/2_Current_Analyses/1_SummaryTables_VariablebyVariable/3_GSimp/GSimp_evaluation.R', local = TRUE)

source('~/Library/CloudStorage/OneDrive-UniversityofNorthCarolinaatChapelHill/Rager_Lab/Projects_Lead/3_COPDEcig_Comparison/2_Current_Analyses/1_SummaryTables_VariablebyVariable/3_GSimp/GSimp.R', local = TRUE)
```

Run imputation (currently commented out but can run if needed):
```{r eval = FALSE}
set.seed(8016)

md_imp <- pre_processing_GS_wrapper(md_forimp)

write.xlsx(md_imp %>% rownames_to_column("SubjectID"), "2_ProcessedData/COPD_MediatorData_Imputed_07.17.2025.xlsx")
```

```{r}
md_imp <- read.xlsx("2_ProcessedData/COPD_MediatorData_Imputed_07.17.2025.xlsx") %>%
  column_to_rownames("SubjectID")
```


Visualize imputation results:
```{r}
# Prepare annotation dataframe indicating which values were originally missing
annotation_missing <- md_forimp %>%
  rownames_to_column("SubjectID") %>%
  pivot_longer(!SubjectID, names_to = "variable", values_to = "value") %>%
  mutate(was_na = ifelse(is.na(value), "Yes", "No")) %>%
  unite(unique_id, SubjectID, variable, sep = ".") %>%
  select(-value)

# Add annotation column and mdl to imputed data frame
md_forimpgraph <- md_imp %>%
  rownames_to_column("SubjectID") %>%
  pivot_longer(!SubjectID, names_to = "variable", values_to = "value") %>%
  unite(unique_id, SubjectID, variable, sep = ".", remove = FALSE) %>%
  left_join(annotation_missing, by = "unique_id") %>%
  left_join(llods, by = "variable") %>%
  mutate(placeholder = 1) %>%
  group_by(variable) %>%
  filter(any(str_detect(was_na, fixed("Yes")))) %>%
  ungroup()

# Graph
set.seed(8016)

imputation_panel <- ggplot(data = md_forimpgraph, aes(x = placeholder, y = value)) +
  geom_hline(aes(yintercept = mdl), linetype = 2, color = "grey32") +
  geom_point(aes(color = was_na), 
             size = 1, 
             alpha = 0.7, 
             position = position_jitter(width = 0.1, height = 0.1)) +
  scale_color_manual(values = c("black", "firebrick"), name = "Was imputed?", labels = c("No", "Yes")) +
  labs(y = "Concentration (pg/mL)") +
  scale_y_log10(expand = c(0, 0.5)) +
  theme(axis.ticks.x = element_blank(),
        axis.title.x = element_blank(),
        axis.text.x = element_blank()) +
  facet_wrap(~variable, scales = "free_y", nrow = 4) 

png(file = "4_Figures/GSimp_Panel.png", width = 7, height = 5, units = "in", res = 1200)
imputation_panel
invisible(dev.off())
  
imputation_panel
```

## Sputum Cell Differential Data

Initial import and filtering. Data were also cleaned to calculate cell percentages and total counts based on non-squamous data because the input file didn't calculate them correctly. 
```{r}
# Import
diffs <- read.xlsx("1_RawData/2022_07_14 COPD Raw Diff Data.xlsx")

# Clean data
diffs_cleaned <- diffs %>%
  filter(SubjectID %in% row.names(md))

# Calculate new percentage parameters
for (i in 3:7) {
  diffs_cleaned$newcol <- diffs_cleaned[[i]]/diffs_cleaned[[10]]*100 # Divide count by total nonsquamous count, times 100
  cell <- strsplit(colnames(diffs_cleaned)[i], split = "_") # Create variable for name of cell type
  cell <- noquote(cell[[1]][1]) # Create variable for name of cell type
  
  names(diffs_cleaned)[names(diffs_cleaned) == 'newcol'] <- noquote(paste0(cell, "_Perc")) # Rename column
}

# Calculate new total cell parameters
for (i in 15:19) {
  diffs_cleaned$newcol <- diffs_cleaned[[i]]/100*(diffs_cleaned[[14]]-diffs_cleaned[[13]]) # Multiply percentage by total cell count - squamous cell count
  cell <- strsplit(colnames(diffs_cleaned)[i], split = "_") # Create variable for name of cell type
  cell <- noquote(cell[[1]][1]) # Create variable for name of cell type
  
  names(diffs_cleaned)[names(diffs_cleaned) == 'newcol'] <- noquote(paste0(cell, "_Count")) # Rename column
}

# Remove columns no longer needed
diffs_cleaned <- diffs_cleaned %>% select(-c(PMN_AVERAGE:TOTAL_AVERAGE_CNT))

# Average duplicates
diffs_duplicates_avg <- diffs_cleaned %>%
  filter(duplicated(SubjectID) | duplicated(SubjectID, fromLast = TRUE)) %>%
  group_by(SubjectID) %>%
  summarize(across(c(SEC_Perc:BEC_Count), \(x) mean(x)))

# Remove duplicates from original dataframe and add back in their averaged data
diffs_cleaned <- diffs_cleaned %>%
  filter(!SubjectID %in% diffs_duplicates_avg$SubjectID) %>%
  select(-SLIDE) %>%
  bind_rows(diffs_duplicates_avg)

# Save cleaned data
write.xlsx(diffs_cleaned, "2_ProcessedData/COPD_DiffData_Cleaned_07.28.2025.xlsx")
```


## Demographics Data

First, read in cleaned demographics table with primary variables of interest:
```{r}
# Import data
demographics <- read.xlsx("1_RawData/2023_06_09 COPD Demographics.xlsx")

# Clean data frame and make new column for GOLD Stage as it will appear 
demographics <- data.frame(demographics[, -1], row.names = demographics$SubjectID) %>%
  mutate("GoldStage" = recode(GoldStratum, "1" = "C", "2" = "p-COPD", 
                                   "3" = "1/2", "4" = "3"))
```

Then, read in additional demographics characteristics to understand prevalence of medication use and additional comorbidities. For sleep apnea, 2 was recoded to NA since it is unclear what that meant.
```{r}
# Import data
demo_full <- read.xlsx("1_RawData/2025_07_17 Demographic Data V1 Full.xlsx")

# Filter to only participants in current study and recode variables as more user-friendly
demo_full_filtered <- demo_full %>%
  dplyr::filter(SUBJID %in% diffs_cleaned$SubjectID) %>%
  dplyr::select(c(SUBJID, ORAL_CORTICOSTEROIDS_V1, THEOPHYLLINE_V1, EYES_ENT_CONDITION_V1_A:APNEA_DIAGNOSED_V1, 
                  INHALEDBRONCHODILATORS_V1:INHALEDSTEROIDS_V1, BECLOVENT_V1:IPRATROPIUMBROMIDE_NEB_V1)) %>%
  left_join(demographics %>% dplyr::select(GoldStage) %>% rownames_to_column("SUBJID"), by = "SUBJID") %>%
  mutate(GoldStage = factor(GoldStage, levels=c("C", "p-COPD", "1/2", "3"), labels=c("Control", "Pre-COPD", "Mild/Moderate COPD (GOLD 1/2)", "Severe COPD (GOLD 3)"))) %>%
  mutate(across(ORAL_CORTICOSTEROIDS_V1:IPRATROPIUMBROMIDE_NEB_V1, ~case_when(. == 1 ~ "Yes", 
                                                                        . == 0 ~ "No", 
                                                                        . == 2 ~ NA,
                                                                        TRUE ~ as.character(.)))) %>%
  rename_with(~ str_replace(., "_V1.*", "")) %>%
  rename_with(.fn = tolower, .cols = -c(SUBJID, GoldStage)) %>%
  rename("chronic_bronchitis_diagnosed" = "cb_diagnosed", "fluticasone_salmeterol" = "fluticasonesalmeterol") %>%
  mutate(across(c(oral_corticosteroids:ipratropiumbromide_neb), \(x) factor(x, levels = c("Yes", "No"))))

# Get variables to paste for secondary demographics table
vars_fortable <- paste(colnames(demo_full_filtered %>% dplyr::select(oral_corticosteroids:ipratropiumbromide_neb)), collapse = "+")

vars_fortable
```

```{r}
demotable_extended <- table1(~ oral_corticosteroids+theophylline+eyes_ent_condition+cardiovascular_condition+gi_condition+pulmonary_vascular_cond+oncology_hema_condition+genitourinary_condition+endocrine_condition+muscular_skeletal_cond+dermatology_condition+infectious_disease_cond+psychiatric_condition+chronic_bronchitis_diagnosed+emphysema_diagnosed+copd_diagnosed+apnea_diagnosed+inhaledbronchodilators+nebulizedbronchodilators+inhaledsteroids+beclovent+vanceril+qvar+albuterol+ipratropiumbromide+ipratbromialbutsulfa+terbutaline+formoterol+tiotropium+salmeterol+pirbuterol+metaproterenol+levalbuterol+bitolterol+epinephrine+fluticasone_salmeterol+budesonideformoterol+formoterol_neb+arformoterol+albuterol_neb+ipratropiumbromide_neb | GoldStage, 
       data = demo_full_filtered, 
       overall = NULL)

demotable_extended

demotable_extended_df <- as.data.frame(demotable_extended)
write.xlsx(demotable_extended_df, "5_Tables/Demotable_Extended.xlsx")
```

# Make demographics table
Prep for making table.
```{r}
# Identify factors that will be the columns in the table and specify the order they will appear.
demographics$Sex <- factor(demographics$Sex, 
                           levels=c("M", "F"), 
                           labels=c("Male", "Female"))

demographics$Race <- factor(demographics$Race, 
                               levels=c("W", "B", "MO", "M"), 
                               labels=c("White", "Black", "Mixed/Other", "Missing"))


demographics$GoldStage <- factor(demographics$GoldStage, 
                            levels=c("C", "p-COPD", "1/2", "3"), 
                            labels=c("Control", "Pre-COPD", 
                                     "Mild/Moderate COPD (GOLD 1/2)", "Severe COPD (GOLD 3)"))

# Create row labels for variables of interest that need reformatting
label(demographics$PercPredFEV1) <- "% Predicted FEV1"
label(demographics$SmokingPackYears) <- "Smoking Pack Year History"
label(demographics$CurrentSmoker) <- "Current Smoker"
label(demographics$Cotinine) <- "Urine Cotinine"
label(demographics$GoldStageCOPDSev) <- "GOLD Stage"

# Determine whether continuous variabes are normally or non-normally distributed
shapiro.test(demographics$Age) # p-value = 0.01591 indicates non-normally distributed
shapiro.test(demographics$BMI) # p-value = 0.06101 indicates normally distributed
shapiro.test(demographics$PercPredFEV1) # p-value = 3.593e-0.05 indicates non-normally distributed
shapiro.test(demographics$SmokingPackYears) # p-value = 8.736e-05 indicates non-normally distributed
shapiro.test(demographics$Cotinine) # p-value = 9.268e-15 indicates non-normally distributed

# Create function for custom table so that Mean (SD) is shown for continuous variables
my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=2), c("",
                                                           "Mean (SD)"=sprintf("%s (&plusmn; %s)", MEAN, SD)))
}


# Function for adding p-values to table
pvalue <- function(x, ...) {
  # Construct vectors of data y, and groups (strata) g
  y <- unlist(x)
  g <- factor(rep(1:length(x), times=sapply(x, length)))
  if (is.numeric(y)) {
    # For numeric variables, perform a non-parametric multiple comparisons test (Kruskal Wallis)
    p <- kruskal.test(y ~ g)$p.value
  } else {
    # For categorical variables, perform a Fisher's exact test (or Chi squared if there are expected frequencies >5)
    # Simulate p value = TRUE added because groups are too small
    p <- fisher.test(table(y, g), simulate.p.value = TRUE)$p.value
  }
  # Format the p-value, using an HTML entity for the less-than sign.
  # The initial empty string places the output on the line below the variable label.
  c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}
```

Make table.
```{r}
# Must set seed when fisher's exact test has simulate = TRUE
set.seed(8016)

# Make table of demographics.
demotable <- table1(~ Sex + Race + Hispanic + Age + BMI + PercPredFEV1 + SmokingPackYears + CurrentSmoker + Cotinine  | GoldStage, 
       data = demographics, 
       render.continuous = my.render.cont,
       overall = NULL,
       extra.col = list(`P-value` = pvalue))

demotable

# Save table
demotable_df <- as.data.frame(demotable)
write.xlsx(demotable_df , "5_Tables/Demotable_Main.xlsx")
```


Code for manually adding additional significance markers to demographics table for continuous variables.
```{r warning = FALSE}
# Function to add significant numbers to data frame
signif.num <- function(x) {
  symnum(x, corr = FALSE, na = FALSE, legend = FALSE,
         cutpoints = c(0, 0.001, 0.01, 0.05, 0.1, 1), 
         symbols = c("***", "**", "*", "+", " "))
}

# Function for Dunn test and nicely formatted results
dunn.test <- function(variable, group, data) {
  res <- dunnTest(as.formula(paste0(variable, "~", group)), data = data, method = "bh")
  res <- data.frame(res$res)
  res <- format(res, scientific = FALSE)
  res$AdjSignif <- signif.num(as.numeric(res$P.adj))
  res
}

AgeDunnRes <- dunn.test("Age", "GoldStage", demographics)
BMIDunnRes <- dunn.test("BMI", "GoldStage", demographics)
FEV1DunnRes <- dunn.test("PercPredFEV1", "GoldStage", demographics)
PackYrDunnRes <- dunn.test("SmokingPackYears", "GoldStage", demographics)
CotinineDunnRes <- dunn.test("Cotinine", "GoldStage", demographics)
```

# Further subject characteristic exploration 

Determine whether urine cotinine values seem to match whether a subject was classified as a current smoker or nonsmoker.
```{r message = FALSE}
theme_set(theme_bw())

demographics$CurrentSmoker <- factor(demographics$CurrentSmoker, c("Yes", "No", "Missing"))

demographics$GoldStage <- factor(demographics$GoldStage, 
                            levels=c("Control", "Pre-COPD", 
                                     "Mild/Moderate COPD (GOLD 1/2)", "Severe COPD (GOLD 3)"), 
                            labels=c("C", "p-COPD","1/2", "3"))

smoker_cotinine_plot <- ggplot(demographics, aes (x = GoldStage, y = Cotinine)) +
  geom_boxplot(color = "black",
               outlier.shape = NA) +
  geom_jitter(position = position_jitter(0.15),
              aes(color = CurrentSmoker),
              size = 2) +
  labs(y = "Urine Cotinine", x = "GOLD Stage") +
  scale_y_continuous(expand = expansion(mult = c(0.25, 0.7))) +
  theme(axis.text.x = element_text(size = 12, color = "black"),
        axis.text.y = element_text(size = 12, color = "black"),
        axis.title.y = element_text(size = 14),
        axis.title.x = element_text (size = 14),
        legend.position = c(0.2, 0.75),
        legend.background = element_rect(fill = "white", 
                                         size = 0.3, 
                                         linetype = "solid",
                                         color = "black"),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_color_viridis_d(name = "Current Smoker", begin = 0.2, end = 0.8, option = "B")

smoker_cotinine_plot
```

# Analysis of between-group differences in sputum cell differentials 

## Assessment of squamous epithelial cell data

Squamous epithelial cell percentages are considered to be an indicator of sample quality - too high of a squamous epithelial cell percentage can indicate that the sample was derived more from the upper airways than the central airways. Different cutoffs are used; we used a cutoff of <80% when selecting our samples initially.
```{r}
squam <- mean(diffs_cleaned$SEC_Perc)
squam_sem <- (sd(diffs_cleaned$SEC_Perc))/(sqrt(length(diffs_cleaned$SEC_Perc)))
squam_max <- max(diffs_cleaned$SEC_Perc)
hist(diffs_cleaned$SEC_Perc)
```

## Assess normality of raw differential data

Normality can be assessed in multiple ways - through statistical testing or manual examination of histograms (qqplots can also be used). 

&nbsp;

Statistical testing of normality for each sputum metric indicates that data are not normally distributed (as expected).
```{r}
shapiro_res_diffs <- diffs_cleaned %>%
  pivot_longer(!SubjectID, names_to = "endpoint", values_to = "value") %>%
  group_by(endpoint) %>%
  shapiro_test(value) %>%
  mutate(normal = ifelse(p < 0.05, F, T))

dplyr::count(shapiro_res_diffs, normal)
```

Histograms also demonstrate that data are not normally distributed. 
```{r warning = FALSE, message = FALSE}
diffs_histograms <- diffs_cleaned %>%
  pivot_longer(!SubjectID, names_to = "endpoint", values_to = "value") %>%
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~ endpoint, scales = "free")

diffs_histograms
```

We can also assess the normality of log2-transformed data:
```{r}
shapiro_res_diffs_log2 <- diffs_cleaned %>%
  pivot_longer(!SubjectID, names_to = "endpoint", values_to = "value") %>%
  mutate(value = log2(value + 1)) %>%
  group_by(endpoint) %>%
  shapiro_test(value) %>%
  mutate(normal = ifelse(p < 0.05, F, T))

dplyr::count(shapiro_res_diffs_log2, normal)
```

```{r warning = FALSE, message = FALSE}
diffs_histograms_log2 <- diffs_cleaned %>%
  pivot_longer(!SubjectID, names_to = "endpoint", values_to = "value") %>%
  mutate(value = log2(value + 1)) %>%
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~ endpoint, scales = "free")

diffs_histograms_log2
```

Although log2 transformation did not move all variables to a completely normal distribution, histograms demonstrate that log2 transformation moves values closer to a normal distribution. 

## ANCOVA on cell differential data

ANCOVA will allow us to determine significant differences between group for each mediator while accounting for covariates. Choosing covariates is subjective, but here I included those that were significantly different in the demographics table, plus sex because of known differences between male and female airway immune responses and biology. Here, we will use the log2-transformed data. There are many different ways to perform an ANCOVA, with different types of sum of squares. Here, we followed the workflow described in the [Datanovia tutorial](https://www.datanovia.com/en/lessons/ancova-in-r/#computation), which uses type II tests and emmeans tests for post-hoc testing. Emmeans is generally considered superior to tukey's HSD because it accounts for means adjusted for covariates, while Tukey's does not. Also note that order of the variables/covariates does not matter for Type II tests, which are the default in rstatix but not the default with base `lm`. That is why for base `lm` function with extracting pairwise comparison using emmeans, we must specify the type in a sequential line of code. Rstatix does contain an `emmeans_test()` function, but it has a known bug with multiple covariates and mixtures of categorical and continuous covariates.

We will start with just the ANCOVA for overall p-values by variable and covariate:

```{r}
# Prepare data by removing columns that aren't of interest, applying log2 transformation, appending demographics, and selecting columns of interest
diff_data_forancova <- diffs_cleaned %>%
  select(-c(SEC_Perc, SEC_Count)) %>%
  mutate(across(c(TCCwSEC:BEC_Count), \(x) log2(x+1))) %>%
  left_join(demographics %>%
              rownames_to_column("SubjectID") %>%
              select(c(SubjectID, BMI, Age, Sex, Race, GoldStage, CurrentSmoker)),
            by = "SubjectID") %>%
  mutate(GoldStage = recode(GoldStage, "C" = "Control", "p-COPD" = "Pre-COPD", 
                            "1/2" = "Mild/Moderate COPD (GOLD 1/2)", "3" = "Severe COPD (GOLD 3)")) %>%
  mutate(GoldStage = factor(GoldStage, levels = c("Control", "Pre-COPD", "Mild/Moderate COPD (GOLD 1/2)", "Severe COPD (GOLD 3)"))) %>%
  left_join(demo_full_filtered %>%
              select(c(SUBJID, cardiovascular_condition, pulmonary_vascular_cond, inhaledsteroids)),
              join_by("SubjectID" == "SUBJID")) %>%
  relocate(GoldStage, .after = "SubjectID") %>%
  relocate(c(BMI:inhaledsteroids), .after = "GoldStage")

# Perform ANCOVA using rstatix package
diff_ancova_res <- diff_data_forancova %>%
  pivot_longer(-c(SubjectID:inhaledsteroids), names_to = "endpoint", values_to = "value") %>%
  group_by(endpoint) %>%
  na.omit() %>%
  anova_test(value ~ GoldStage + BMI + Age + Sex + Race + CurrentSmoker + cardiovascular_condition + pulmonary_vascular_cond + inhaledsteroids) %>%
  get_anova_table() %>% data.frame() %>%
  select(c(endpoint, Effect, p)) %>%
  pivot_wider(id_cols = "endpoint", names_from = "Effect", values_from = "p")

# Clean results for export for supplemental material
diff_ancova_res_cleaned <- diff_ancova_res %>%
  rename("Variable" = "endpoint", "GOLD Stage" = "GoldStage", "Current Smoker" = "CurrentSmoker", 
         "Cardiovascular Condition" = "cardiovascular_condition", "Pulmonary Vascular Condition" = "pulmonary_vascular_cond", "Inhaled Steroids" = "inhaledsteroids") 

# Create workbook to store these results and other statistical results for the supplementary tables
wb <- createWorkbook()

# Create bold and scientific styles for workbook
bold <- createStyle(textDecoration = "bold")
scientific <- createStyle(numFmt = "0.00E+00")

# Save data into worksheet
addWorksheet(wb, "Diffs_ANCOVA_Results")
writeData(wb, "Diffs_ANCOVA_Results", diff_ancova_res_cleaned)
addStyle(wb, "Diffs_ANCOVA_Results", style = scientific, rows = 2:(nrow(diff_ancova_res_cleaned) + 1), cols = 2:ncol(diff_ancova_res_cleaned), gridExpand = TRUE)
conditionalFormatting(wb, sheet = "Diffs_ANCOVA_Results", 
                      rows = 2:(nrow(diff_ancova_res_cleaned) + 1), cols = 2:ncol(diff_ancova_res_cleaned), 
                      rule = "<0.05", style = bold)
saveWorkbook(wb, "5_Tables/VariableByVariable_SupplementalResults.xlsx", overwrite = TRUE)
```

Then, we can follow up with the EMM test. Note that to only compare values back to the control, the following lines of script should be used:

1. Add `data = map(data, ~ .x %>% mutate(GoldStage = relevel(factor(GoldStage), ref = "C"))),` as the first line after `mutate()`
2. Change the contrast line to: `contrast = map(emm, ~ contrast(.x, method = "trt.vs.ctrl", ref = "C", adjust = "BH")),`

However, here we will produce all comparisons. 
```{r}
# Perform pairwise posthoc testing using emmeans
diff_ancova_nested <- diff_data_forancova %>%
  mutate(GoldStage = recode(GoldStage, "Control" = "Control", "Pre-COPD" = "Pre-COPD", "Mild/Moderate COPD (GOLD 1/2)" = "GOLD 1/2", "Severe COPD (GOLD 3)" = "GOLD 3")) %>%
  mutate(GoldStage = factor(GoldStage, levels = c("Control", "Pre-COPD", "GOLD 1/2", "GOLD 3"))) %>%
  pivot_longer(-c(SubjectID:inhaledsteroids), names_to = "endpoint", values_to = "value") %>%
  group_by(endpoint) %>%
  na.omit() %>%
  nest()

diff_ancova_pairwise_res <- diff_ancova_nested %>%
  
  mutate(
    
    # Run ANCOVA and specify type II error to parallel the rstatix test above
    model = map(data, ~lm(value ~ GoldStage + BMI + Age + Sex + Race + CurrentSmoker + cardiovascular_condition + pulmonary_vascular_cond + inhaledsteroids, data = .x)),
    anova_type2 = map(model, ~ Anova(.x, type = 2) %>% as.data.frame() %>% rownames_to_column("term")),
    
    # Perform mmeans test only comparing back to the control group
    emm = map(model, ~ emmeans(.x, specs = "GoldStage")),
    contrast = map(emm, ~ contrast(.x, method = "pairwise", adjust = "BH")),
    contrast_df = map(contrast, as_tibble)
    
  ) %>%
  
  # Clean up dataframe
  select(endpoint, contrast_df) %>%
  unnest(contrast_df, names_repair = "unique") %>%
  select(c(endpoint, contrast, p.value)) %>%
  mutate(contrast = gsub(" - ", " vs. ", contrast),
         contrast = str_replace_all(contrast, "[()]", "")) %>%
  pivot_wider(id_cols = "endpoint", names_from = "contrast", values_from = "p.value") %>%
  rename("Variable" = "endpoint") %>%
  arrange(Variable)

# Save data into worksheet
addWorksheet(wb, "Diffs_EMM_Results")
writeData(wb, "Diffs_EMM_Results", diff_ancova_pairwise_res)
addStyle(wb, "Diffs_EMM_Results", style = scientific, rows = 2:(nrow(diff_ancova_pairwise_res) + 1), cols = 2:ncol(diff_ancova_pairwise_res), gridExpand = TRUE)
conditionalFormatting(wb, sheet = "Diffs_EMM_Results", 
                      rows = 2:(nrow(diff_ancova_pairwise_res) + 1), cols = 2:ncol(diff_ancova_pairwise_res), 
                      rule = "<0.05", style = bold)
saveWorkbook(wb, "5_Tables/VariableByVariable_SupplementalResults.xlsx", overwrite = TRUE)
```


## Summary table of raw differential data

Make summary table of means and SDs. Use the output table from the last chunk of code to annotate the more beautified and organized table in the manuscript document. 
```{r}
# Prepare data
diff_data_fortable <- diffs_cleaned %>%
  select(-c(SEC_Perc, SEC_Count)) %>%
  left_join(demographics %>%
              rownames_to_column("SubjectID") %>%
              select(c(SubjectID, GoldStage)),
            by = "SubjectID")

# Calculate means
diffs_table_means <- diff_data_fortable %>%
  group_by(GoldStage) %>%
  summarise(across(c(TCCwSEC:BEC_Count), \(x) mean(x, na.rm = TRUE))) %>%
  pivot_longer(!GoldStage, names_to = "Variable", values_to = "Value") %>%
  mutate(Value = ifelse(Value > 1000, round(Value, digits = 0), round(Value, digits = 2))) %>%
  mutate(Value = format(Value, big.mark = ",")) %>%
  mutate(Value = case_when(grepl(".00", Value) ~ sub(".0+$", "", Value), .default = as.character(Value))) %>%
  mutate(Value = trimws(Value)) %>%
  rename("mean" = "Value") %>%
  unite("GoldStage_Variable", GoldStage, Variable, sep = "_", remove = FALSE)

# Store plus/minus character
x<-"\u00b1"
Encoding(x)<-"UTF-8"
start_paren <- paste0("(", x, " ", sep = "")

# Calculate standard deviations
diffs_table_sd <- diff_data_fortable %>%
  group_by(GoldStage) %>%
  summarise(across(c(TCCwSEC:BEC_Count), \(x) sd(x, na.rm = TRUE))) %>%
  pivot_longer(!GoldStage, names_to = "Variable", values_to = "Value") %>%
  mutate(Value = ifelse(Value > 1000, round(Value, digits = 0), round(Value, digits = 2))) %>%
  mutate(Value = format(Value, big.mark = ",")) %>%
  mutate(Value = case_when(grepl(".00", Value) ~ sub(".0+$", "", Value), .default = as.character(Value))) %>%
  mutate(Value = trimws(Value)) %>%
  mutate(Value = paste0(start_paren, Value, ")", sep ="")) %>%
  rename("SD" = "Value") %>%
  unite("GoldStage_Variable", GoldStage, Variable, sep = "_", remove = FALSE)

# Combine data frames and reformat 
diffs_table_summarystats <- left_join(diffs_table_means, 
                                      diffs_table_sd %>% dplyr::select(c(GoldStage_Variable, SD)),
                                      by = "GoldStage_Variable") %>%
  mutate(GoldStage = recode(GoldStage, "C" = "Control", "p-COPD" = "Pre-COPD", 
                            "1/2" = "Mild/Moderate COPD (GOLD 1/2)", "3" = "Severe COPD (GOLD 3)")) %>%
  unite("Mean_SD", mean, SD, sep = " ", remove = TRUE) %>%
  dplyr::select(-c(GoldStage_Variable)) %>%
  pivot_wider(names_from = GoldStage, values_from = Mean_SD) %>%
  left_join(diff_ancova_res %>% select(c(endpoint, GoldStage)), join_by("Variable" == "endpoint")) %>%
  rename("Overall p-value" = "GoldStage")
  
write.xlsx(diffs_table_summarystats, "5_Tables/Table_Diffs_SummaryStats.xlsx")
```


# Analysis of between-group differences in induced sputum supernatant soluble mediators

## Assess normality of raw mediator data

Statistical testing of normality for each mediator indicates that data are not normally distributed (as expected).
```{r}
shapiro_res_md <- md_imp %>%
  rownames_to_column("SubjectID") %>%
  pivot_longer(!SubjectID, names_to = "endpoint", values_to = "value") %>%
  group_by(endpoint) %>%
  shapiro_test(value) %>%
  mutate(normal = ifelse(p < 0.05, F, T))

dplyr::count(shapiro_res_md, normal)
```

Histograms also demonstrate that data are not normally distributed. 
```{r warning = FALSE, message = FALSE}
diffs_md <- md_imp %>%
  rownames_to_column("SubjectID") %>%
  pivot_longer(!SubjectID, names_to = "endpoint", values_to = "value") %>%
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~ endpoint, scales = "free")

diffs_md
```

We can also assess the normality of log2-transformed data:
```{r}
shapiro_res_md_log2 <-  md_imp %>%
  rownames_to_column("SubjectID") %>%
  pivot_longer(!SubjectID, names_to = "endpoint", values_to = "value") %>%
  mutate(value = log2(value + 1)) %>%
  group_by(endpoint) %>%
  shapiro_test(value) %>%
  mutate(normal = ifelse(p < 0.05, F, T))

dplyr::count(shapiro_res_md_log2, normal)
```

```{r warning = FALSE, message = FALSE}
md_histograms_log2 <- md_imp %>%
  rownames_to_column("SubjectID") %>%
  pivot_longer(!SubjectID, names_to = "endpoint", values_to = "value") %>%
  mutate(value = log2(value + 1)) %>%
  ggplot(aes(value)) +
  geom_histogram() +
  facet_wrap(~ endpoint, scales = "free")

md_histograms_log2
```

Although log2 transformation did not move all variables to a completely normal distribution, histograms demonstrate that log2 transformation moves values closer to a normal distribution. 

## ANCOVA on cell differential data

Following the same workflow as with the differential data above. First, overall ANCOVA p-values:

```{r}
# Prepare data by removing columns that aren't of interest, applying log2 transformation, appending demographics, and selecting columns of interest
md_forancova <- md_imp %>%
  rownames_to_column("SubjectID") %>%
  mutate(across(where(is.numeric), \(x) log2(x+1))) %>%
  left_join(demographics %>%
              rownames_to_column("SubjectID") %>%
              select(c(SubjectID, BMI, Age, Sex, Race, GoldStage, CurrentSmoker)),
            by = "SubjectID") %>%
  mutate(GoldStage = recode(GoldStage, "C" = "Control", "p-COPD" = "Pre-COPD", 
                            "1/2" = "Mild/Moderate COPD (GOLD 1/2)", "3" = "Severe COPD (GOLD 3)")) %>%
  mutate(GoldStage = factor(GoldStage, levels = c("Control", "Pre-COPD", "Mild/Moderate COPD (GOLD 1/2)", "Severe COPD (GOLD 3)"))) %>%
  left_join(demo_full_filtered %>%
              select(c(SUBJID, cardiovascular_condition, pulmonary_vascular_cond, inhaledsteroids)),
              join_by("SubjectID" == "SUBJID")) %>%
  relocate(GoldStage, .after = "SubjectID") %>%
  relocate(c(BMI:inhaledsteroids), .after = "GoldStage")

# Perform ANCOVA using rstatix package
md_ancova_res <- md_forancova %>%
  pivot_longer(-c(SubjectID:inhaledsteroids), names_to = "endpoint", values_to = "value") %>%
  group_by(endpoint) %>%
  na.omit() %>%
  anova_test(value ~ GoldStage + BMI + Age + Sex + Race + CurrentSmoker + cardiovascular_condition + pulmonary_vascular_cond + inhaledsteroids) %>%
  get_anova_table() %>% data.frame() %>%
  select(c(endpoint, Effect, p)) %>%
  pivot_wider(id_cols = "endpoint", names_from = "Effect", values_from = "p")

# Clean results for export for supplemental material
md_ancova_res_cleaned <- md_ancova_res %>%
  rename("Variable" = "endpoint", "GOLD Stage" = "GoldStage", "Current Smoker" = "CurrentSmoker", 
         "Cardiovascular Condition" = "cardiovascular_condition", "Pulmonary Vascular Condition" = "pulmonary_vascular_cond", "Inhaled Steroids" = "inhaledsteroids")

# Save data into worksheet
addWorksheet(wb, "Mediators_ANCOVA_Results")
writeData(wb, "Mediators_ANCOVA_Results", md_ancova_res_cleaned)
addStyle(wb, "Mediators_ANCOVA_Results", style = scientific, rows = 2:(nrow(md_ancova_res_cleaned) + 1), cols = 2:ncol(md_ancova_res_cleaned), gridExpand = TRUE)
conditionalFormatting(wb, sheet = "Mediators_ANCOVA_Results", 
                      rows = 2:(nrow(md_ancova_res_cleaned) + 1), cols = 2:ncol(md_ancova_res_cleaned), 
                      rule = "<0.05", style = bold)
saveWorkbook(wb, "5_Tables/VariableByVariable_SupplementalResults.xlsx", overwrite = TRUE)

nrow(md_ancova_res %>% filter(GoldStage < 0.05))
```


Then, pairwise testing:
```{r}
# Perform pairwise posthoc testing using emmeans
md_ancova_nested <- md_forancova %>%
  mutate(GoldStage = recode(GoldStage, "Control" = "Control", "Pre-COPD" = "Pre-COPD", "Mild/Moderate COPD (GOLD 1/2)" = "GOLD 1/2", "Severe COPD (GOLD 3)" = "GOLD 3")) %>%
  mutate(GoldStage = factor(GoldStage, levels = c("Control", "Pre-COPD", "GOLD 1/2", "GOLD 3"))) %>%
  pivot_longer(-c(SubjectID:inhaledsteroids), names_to = "endpoint", values_to = "value") %>%
  group_by(endpoint) %>%
  na.omit() %>%
  nest()

md_ancova_pairwise_res <- md_ancova_nested %>%
  
  mutate(
    
    # Run ANCOVA and specify type II error to parallel the rstatix test above
    model = map(data, ~lm(value ~ GoldStage + BMI + Age + Sex + Race + CurrentSmoker + cardiovascular_condition + pulmonary_vascular_cond + inhaledsteroids, data = .x)),
    anova_type2 = map(model, ~ Anova(.x, type = 2) %>% as.data.frame() %>% rownames_to_column("term")),
    
    # Perform mmeans test only comparing back to the control group
    emm = map(model, ~ emmeans(.x, specs = "GoldStage")),
    contrast = map(emm, ~ contrast(.x, method = "pairwise", adjust = "BH")),
    contrast_df = map(contrast, as_tibble)
    
  ) %>%
  
  # Clean up dataframe
  select(endpoint, contrast_df) %>%
  unnest(contrast_df, names_repair = "unique") %>%
  select(c(endpoint, contrast, p.value)) %>%
  mutate(contrast = gsub(" - ", " vs. ", contrast),
         contrast = str_replace_all(contrast, "[()]", "")) %>%
  pivot_wider(id_cols = "endpoint", names_from = "contrast", values_from = "p.value") %>%
  rename("Variable" = "endpoint") %>%
  arrange(Variable)

# Save data into worksheet
addWorksheet(wb, "Mediators_EMM_Results")
writeData(wb, "Mediators_EMM_Results", md_ancova_pairwise_res)
addStyle(wb, "Mediators_EMM_Results", style = scientific, rows = 2:(nrow(md_ancova_pairwise_res) + 1), cols = 2:ncol(md_ancova_pairwise_res), gridExpand = TRUE)
conditionalFormatting(wb, sheet = "Mediators_EMM_Results", 
                      rows = 2:(nrow(md_ancova_pairwise_res) + 1), cols = 2:ncol(md_ancova_pairwise_res), 
                      rule = "<0.05", style = bold)
saveWorkbook(wb, "5_Tables/VariableByVariable_SupplementalResults.xlsx", overwrite = TRUE)
```


## Summary table of mediator data and p-values from ANCOVA

Create summary values:

```{r}
# Store plus/minus character
x<-"\u00b1"
Encoding(x)<-"UTF-8"
start_paren <- paste0("(", x, " ", sep = "")

# Calculate means
md_table_means <- md_imp %>%
  rownames_to_column("SubjectID") %>% 
  left_join(demographics %>%
              rownames_to_column("SubjectID") %>%
              select(c(SubjectID, GoldStage)),
            by = "SubjectID") %>%
  mutate(GoldStage = recode(GoldStage, "C" = "Control", "p-COPD" = "Pre-COPD", 
                            "1/2" = "Mild/Moderate COPD (GOLD 1/2)", "3" = "Severe COPD (GOLD 3)")) %>%
  mutate(GoldStage = factor(GoldStage, levels = c("Control", "Pre-COPD", "Mild/Moderate COPD (GOLD 1/2)", "Severe COPD (GOLD 3)"))) %>%
  group_by(GoldStage) %>%
  summarise(across(where(is.numeric), \(x) mean(x, na.rm = TRUE))) %>%
  pivot_longer(!GoldStage, names_to = "Variable", values_to = "Value") %>%
  mutate(Value = ifelse(Value > 1000, round(Value, digits = 0), round(Value, digits = 2))) %>%
  mutate(Value = format(Value, big.mark = ",")) %>%
  mutate(Value = case_when(grepl(".00", Value) ~ sub(".0+$", "", Value), .default = as.character(Value))) %>%
  mutate(Value = trimws(Value)) %>%
  rename("mean" = "Value") %>%
  unite("GoldStage_Variable", GoldStage, Variable, sep = "_", remove = FALSE)

# Calculate standard deviations
md_table_sd <- md_imp %>%
  rownames_to_column("SubjectID") %>% 
  left_join(demographics %>%
              rownames_to_column("SubjectID") %>%
              select(c(SubjectID, GoldStage)),
            by = "SubjectID") %>%
  mutate(GoldStage = recode(GoldStage, "C" = "Control", "p-COPD" = "Pre-COPD", 
                            "1/2" = "Mild/Moderate COPD (GOLD 1/2)", "3" = "Severe COPD (GOLD 3)")) %>%
  mutate(GoldStage = factor(GoldStage, levels = c("Control", "Pre-COPD", "Mild/Moderate COPD (GOLD 1/2)", "Severe COPD (GOLD 3)"))) %>%
  group_by(GoldStage) %>%
  summarise(across(where(is.numeric), \(x) sd(x, na.rm = TRUE))) %>%
  pivot_longer(!GoldStage, names_to = "Variable", values_to = "Value") %>%
  mutate(Value = ifelse(Value > 1000, round(Value, digits = 0), round(Value, digits = 2))) %>%
  mutate(Value = format(Value, big.mark = ",")) %>%
  mutate(Value = case_when(grepl(".00", Value) ~ sub(".0+$", "", Value), .default = as.character(Value))) %>%
  mutate(Value = trimws(Value)) %>%
  mutate(Value = paste0(start_paren, Value, ")", sep ="")) %>%
  rename("SD" = "Value") %>%
  unite("GoldStage_Variable", GoldStage, Variable, sep = "_", remove = FALSE)

# Combine data frames and reformat 
md_table_summarystats <- left_join(md_table_means, 
                                      md_table_sd %>% dplyr::select(c(GoldStage_Variable, SD)),
                                      by = "GoldStage_Variable") %>%
  unite("Mean_SD", mean, SD, sep = " ", remove = TRUE) %>%
  dplyr::select(-c(GoldStage_Variable)) %>%
  pivot_wider(names_from = GoldStage, values_from = Mean_SD) %>%
  left_join(md_ancova_res %>% select(c(endpoint, GoldStage)), join_by("Variable" == "endpoint")) %>%
  rename("Overall p-value" = "GoldStage")

# Save data into worksheet
write.xlsx(md_table_summarystats, "5_Tables/Table_Mediators_SummaryStats.xlsx")
```


## Graphing a subset of (ANCOVA) statistically significant mediators

### Visualize overall patterns in mediators

Preparations for graphing:

```{r}
# Filter mediators to only those that were statistically significant using ANCOVA. First, make a vector of proteins that had p < 0.05 for Gold Stratum in ANCOVA
ANCOVAres_mediators_signif <- md_ancova_res %>%
  filter(GoldStage < 0.05) %>%
  pull("endpoint")

# Prepare individual data points
md_log_forgraph <- md_imp %>%
  rownames_to_column("SubjectID") %>%
  mutate(across(where(is.numeric), \(x) log2(x+1))) %>%
  left_join(demographics %>%
              rownames_to_column("SubjectID") %>%
              select(c(SubjectID, BMI, Age, Sex, Race, GoldStage, CurrentSmoker)),
            by = "SubjectID") %>%
  dplyr::select(c(GoldStage, all_of(ANCOVAres_mediators_signif))) %>%
  mutate(GoldStage = recode(GoldStage, "C" = "Control", "p-COPD" = "Pre-COPD", 
                            "1/2" = "Mild/Moderate COPD (GOLD 1/2)", "3" = "Severe COPD (GOLD 3)")) %>%
  pivot_longer(!GoldStage, names_to = "Variable", values_to = "Value") %>%
  mutate(GoldStage = recode(GoldStage, "Control" = "Control", "Pre-COPD" = "Pre-COPD", "Mild/Moderate COPD (GOLD 1/2)" = "GOLD 1/2", "Severe COPD (GOLD 3)" = "GOLD 3"))

# Heights for the label of each significance star
heights_forgraph <- md_log_forgraph %>%
  group_by(Variable) %>%
  mutate(height = max(Value) * 1.5) %>%
  unite(Comparison_Variable, GoldStage, Variable, sep = "_")

# What the labels should be
label_df <- md_ancova_pairwise_res %>%
  filter(Variable %in% all_of(ANCOVAres_mediators_signif)) %>%
  column_to_rownames("Variable") %>%
  t() %>% data.frame() %>%
  rownames_to_column("Comparison") %>%
  separate(Comparison, into = c("g1", "g2"), sep = " vs. ") %>%
  mutate(g1 = recode(g1, "Control" = "C", "Pre-COPD" = "p-COPD", "GOLD 1/2" = "1/2", "GOLD 3" = "3")) %>%
  mutate(g2 = recode(g2, "Control" = "C", "Pre-COPD" = "p-COPD", "GOLD 1/2" = "1/2", "GOLD 3" = "3"))

label_df_s1 <- label_df %>%
  filter(g1 == "C" | g2 == "C") %>%
  mutate(g1 = gsub("C", "", g1)) %>%
  unite(Comparison, g1, g2, sep = "") %>%
  add_row(Comparison = "C") %>%
  pivot_longer(!Comparison, names_to = "Variable", values_to = "Value") %>%
  mutate(Value = ifelse(Value < 0.05, "C", "")) %>%
  mutate(Value = replace_na(Value, "")) %>%
  unite(Comparison_Variable, Comparison, Variable, sep = "_") %>%
  rename("Value_1" = "Value")

label_df_s2 <- label_df %>%
  filter(g1 == "p-COPD" | g2 == "p-COPD") %>%
  mutate_all(~gsub("p-COPD", "", .)) %>%
  unite(Comparison, g1, g2, sep = "") %>%
  add_row(Comparison = "p-COPD") %>%
  pivot_longer(!Comparison, names_to = "Variable", values_to = "Value") %>%
  mutate(Value = ifelse(Value < 0.05, "P", "")) %>%
  mutate(Value = replace_na(Value, "")) %>%
  unite(Comparison_Variable, Comparison, Variable, sep = "_") %>%
  rename("Value_2" = "Value")

label_df_s3 <- label_df %>%
  filter(g1 == "1/2" | g2 == "1/2") %>%
  mutate_all(~gsub("1/2", "", .)) %>%
  unite(Comparison, g1, g2, sep = "") %>%
  add_row(Comparison = "1/2") %>%
  pivot_longer(!Comparison, names_to = "Variable", values_to = "Value") %>%
  mutate(Value = ifelse(Value < 0.05, "1/2", "")) %>%
  mutate(Value = replace_na(Value, "")) %>%
  unite(Comparison_Variable, Comparison, Variable, sep = "_") %>%
  rename("Value_3" = "Value")

label_df_s4 <- label_df %>%
  filter(g1 == "3" | g2 == "3") %>%
  mutate_all(~gsub("3", "", .)) %>%
  unite(Comparison, g1, g2, sep = "") %>%
  add_row(Comparison = "3") %>%
  pivot_longer(!Comparison, names_to = "Variable", values_to = "Value") %>%
  mutate(Value = ifelse(Value < 0.05, "3", "")) %>%
  mutate(Value = replace_na(Value, "")) %>%
  unite(Comparison_Variable, Comparison, Variable, sep = "_") %>%
  rename("Value_4" = "Value")

all_dfs <- list(label_df_s1, label_df_s2, label_df_s3, label_df_s4)

# Combine data frames using reduce function. Then combine each column to make labels.
label_df_final <- all_dfs %>%
  purrr::reduce(full_join, by = "Comparison_Variable") %>%
  mutate_if(is.character, list(~na_if(.,""))) %>%
  mutate(Comparison_Variable = gsub("p-COPD", "Pre-COPD", Comparison_Variable),
         Comparison_Variable = gsub("1/2", "GOLD 1/2", Comparison_Variable), 
         Comparison_Variable = gsub("3", "GOLD 3", Comparison_Variable),
         Comparison_Variable = gsub("C_", "Control_", Comparison_Variable)) %>%
  unite(Label, Value_1, Value_2, Value_3, Value_4, sep = ",", na.rm = TRUE) %>%
  left_join(heights_forgraph %>% dplyr::select(-Value), by = "Comparison_Variable") %>%
  separate(Comparison_Variable, into = c("Comparison", "Variable"), sep = "_") %>%
  rename("GoldStage" = "Comparison") %>%
  mutate(Label = ifelse(GoldStage == "Control", "", Label)) %>% # Remove labels for stratum 1 since they are duplicates
  mutate(Label = ifelse(Label == "3", "", Label)) %>% # Remove label for if only group 4 is significant, as this will be captured by other labels
  unique()
```

Now we can make a graph with the annotations. Here, increased in GOLD 3 only:
```{r}
# Increased in stratum 4 only
s4only_variables <- c("CRP", "IL10", "IL12p70", "IL8", "IP10", "TNFa")

md_log_forgraph_s4only <- md_log_forgraph %>%
  filter(Variable %in% s4only_variables)

label_df_final_s4only <- label_df_final %>%
  filter(Variable %in% s4only_variables)

# Cleaner names
facet_labels_s4only <- c("CRP" = "CRP", "IL10" = "IL-10", "IL12p70" = "IL12p70", "IL8" = "IL-8", "IP10" = "IP-10", "TNFa" = "TNF\u03B1")

# Make graph
theme_set(theme_bw())

mediator_figurepanel_withsig_s4only <- ggplot(md_log_forgraph_s4only) +
  geom_boxplot(aes(x = GoldStage, y = Value, fill = GoldStage), color = "black", outlier.shape = NA) +
  geom_jitter(aes(x = GoldStage, y = Value, fill = GoldStage), position = position_jitter(0.15), 
              shape = 20) +
  geom_text(data = label_df_final_s4only, aes(x = GoldStage, y = height, 
                                       label = paste0(Label)), size = 3) +
  labs(y = bquote(~Log[2]~'(Concentration (pg/mL))'), x = "Group", title = "Mediators Significantly Increased in GOLD 3") +
  facet_wrap( ~Variable, scales = "free_y", nrow = 1, labeller = labeller(Variable = facet_labels_s4only)) +
  scale_y_continuous(expand = expansion(mult = c(0.25, 0.2))) +
  theme(strip.text = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 10, color = "black", angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8, color = "black"),
        axis.title.y = element_text(size = 12, margin = ggplot2::margin(t = 0, r = 10, b = 0, l = 0, unit = "pt")),
        axis.title.x = element_text(size = 12, margin = ggplot2::margin(t = 10, r = 0, b = 0, l = 0, unit = "pt")),
        plot.title = element_text(size = 14, color = "black", face = "bold", margin = ggplot2::margin(t = 0, r = 0, b = 10, l = 0, unit = "pt"), hjust = 0.5),
        legend.position = "none",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_fill_viridis_d(begin = 0.25, end = 1, option = "B")

mediator_figurepanel_withsig_s4only
```
Now we can make a graph with the annotations. Here, increased in stratum 2 and 4:
```{r}
# Increased in stratum 4 only
s2s4_variables <- c("MMP9", "MPO", "NE", "TIMP1", "TIMP2")

md_log_forgraph_s2s4 <- md_log_forgraph %>%
  filter(Variable %in% s2s4_variables)

label_df_final_s2s4 <- label_df_final %>%
  filter(Variable %in% s2s4_variables)

# Make graph
theme_set(theme_bw())

mediator_figurepanel_withsig_s2s4 <- ggplot(md_log_forgraph_s2s4) +
  geom_boxplot(aes(x = GoldStage, y = Value, fill = GoldStage), color = "black", outlier.shape = NA) +
  geom_jitter(aes(x = GoldStage, y = Value, fill = GoldStage), position = position_jitter(0.15), 
              shape = 20) +
  geom_text(data = label_df_final_s2s4, aes(x = GoldStage, y = height, 
                                       label = paste0(Label)), size = 3) +
  labs(y = bquote(~Log[2]~'(Concentration (pg/mL))'), x = "Group", title = "Mediators Significantly Increased in Pre-COPD & GOLD 3") +
  facet_wrap( ~Variable, scales = "free_y", nrow = 1) +
  scale_y_continuous(expand = expansion(mult = c(0.25, 0.2))) +
  theme(strip.text = element_text(size = 12, face = "bold"),
        axis.text.x = element_text(size = 10, color = "black", angle = 45, hjust = 1),
        axis.text.y = element_text(size = 8, color = "black"),
        axis.title.y = element_text(size = 12, margin = ggplot2::margin(t = 0, r = 10, b = 0, l = 0, unit = "pt")),
        axis.title.x = element_text(size = 12, margin = ggplot2::margin(t = 10, r = 0, b = 0, l = 0, unit = "pt")),
        plot.title = element_text(size = 14, color = "black", face = "bold", margin = ggplot2::margin(t = 0, r = 0, b = 10, l = 0, unit = "pt"), hjust = 0.5),
        legend.position = "none",
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  scale_fill_viridis_d(begin = 0.25, end = 1, option = "B")

mediator_figurepanel_withsig_s2s4
```

Put together final figure panel:
```{r}
# Set plot layout to have an empty space to the right of the lower row (so plot panels are the same size)
layout <- "
AAAAAA
BBBBB#
"

mediator_panel <- mediator_figurepanel_withsig_s4only / mediator_figurepanel_withsig_s2s4 + 
  plot_layout(design = layout) +
  plot_annotation(tag_levels = 'A') &
  theme(plot.tag = element_text(size = 16, face = "bold"))


png("4_Figures/SolubleMediator_Panel.png", width = 12, height = 8, units = "in", res = 1200)
mediator_panel
invisible(dev.off())

mediator_panel
```

## Graphing beta coefficients

First, extract beta coefficients and other variables of interest from the model for supplemental material.

```{r}
# Prepare dataframe
md_forcoeffs <- md_forancova %>%
  mutate(across(c(CurrentSmoker:inhaledsteroids), \(x) factor(x, levels = c("No", "Yes")))) %>%
  mutate(GoldStage = recode(GoldStage, "Pre-COPD" = "PreCOPD", "Mild/Moderate COPD (GOLD 1/2)" = "GOLD1/2", "Severe COPD (GOLD 3)" = "GOLD3")) %>%
  rename("CardioCond" = "cardiovascular_condition", "PulmVascCond" = "pulmonary_vascular_cond", 
         "InhaledSteroids" = "inhaledsteroids")

# Vector of proteins
proteins <- colnames(md_forancova %>% select(c(ALB:VEGF)))

# Data frame for saving
out_list <- vector("list", length(proteins))
names(out_list) <- proteins

# Run for loop
for (i in seq_along(proteins)) {
  
  # Define protein for this loop
  prot <- proteins[i]

  # Model formula
  fml <- as.formula(paste(prot, "~ GoldStage + BMI + Age + Sex + Race + CurrentSmoker + CardioCond + PulmVascCond + InhaledSteroids"))
  
  # Fit model 
  fit <- lm(fml, data = md_forcoeffs)
  
  # Get coefficients and other variables of interest
  coefs <- broom::tidy(fit, conf.int = TRUE, conf.level = 0.95) %>%
    mutate(protein = prot, term = as.character(term)) %>%
    select(protein, term, estimate, std.error, p.value, conf.high, conf.low) %>%
    filter(term != "(Intercept)")
  
  out_list[[i]] <- coefs
}

coeffs <- dplyr::bind_rows(out_list) %>%
  rename("Variable" = "protein", "Term" = "term", "Estimate_Beta_Coeff" = "estimate", "StdError" = "std.error",
         "p_value" = "p.value", "Estimate_Conf_High" = "conf.high", "Estimate_Conf_Low" = "conf.low") %>%
  relocate(c(Estimate_Conf_Low, Estimate_Conf_High), .after = "Estimate_Beta_Coeff")

# Save results
addWorksheet(wb, "Mediators_Coeffs_Conf_Results")
writeData(wb, "Mediators_Coeffs_Conf_Results", coeffs)
saveWorkbook(wb, "5_Tables/VariableByVariable_SupplementalResults.xlsx", overwrite = TRUE)
```

Now, referencing the summary table of overall p-values for different proteins and covariates, we will plot the beta coefficients with confidence intervals for the following pairs of proteins and covariates:

- Age: IL8
- Race: ALB, MMP2
- Sex: CC16
- Current Smoking: IL10
- Inhaled Steroids: IL10 

```{r}
# Filter data frame to only proteins and covariates of interest 
coeffs_forplot <- coeffs %>% 
  filter(Variable == "IL8" & Term == "Age" | 
           Variable == "MMP2" & str_detect(Term, "Race") | 
           Variable == "IL10" & str_detect(Term, "InhaledSteroids") | 
           Variable == "CC16" & str_detect(Term, "Sex") | 
           Variable == "ALB" & str_detect(Term, "Race") |
           Variable == "IL10" & str_detect(Term, "CurrentSmoker")) %>%
  unite(Variable_Term, Variable, Term, sep = "_", remove = FALSE) %>%
  mutate(sig = ifelse(p_value < 0.05, "Significant", "Not Significant"))

# Make plot
coeff_forest_plot <- ggplot(coeffs_forplot, aes(x = Variable_Term, y = Estimate_Beta_Coeff, ymin = Estimate_Conf_Low, ymax = Estimate_Conf_High)) +
  geom_hline(yintercept = 0, linetype = 2, color = "grey50") +
  geom_pointrange(aes(color = sig), fatten = 1.5, size = 0.5) +
  scale_color_manual(values = c(`Significant` = "red3", `Not Significant` = "black"), name = "Significance (p < 0.05)") +
  coord_flip() + 
  labs(y = " (estimate) with 95% Confidence Interval", 
       title = "Forest Plot for Proteins and Covariates \nWith Overall Significance via ANCOVA") +
  theme(axis.title.y = element_blank(),
        axis.text = element_text(size = 10, color = "black"),
        plot.title = element_text(size = 12, hjust = 0.5))

coeff_forest_plot

# Save plot
png("4_Figures/ForestPlot.png", width = 7, height = 5, units = "in", res = 1200)
coeff_forest_plot
invisible(dev.off())
```


